<style>
    .userRole tr:nth-child(0){background:#fff}
    .dataTables_processing{text-align: center}
</style>

<div class="modal-header">
    <button type="button" class="close"
            data-dismiss="modal" aria-hidden="true">
        &times;
    </button>
    <h4 class="modal-title" id="myModalLabel">
        人员配置
    </h4>
</div>

<div style="margin: 0px 15px;">
    <table id="userList" class="table table-striped table-bordered table-hover dataTables-example">
        <thead>
        <tr>
            <th><!--<input type="checkbox" name="selectedUser" />--></th>
            <th>用户名</th>
            <th>已有角色</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script>
    var code =  $("#myModal").attr("data-code");
    var selectedCode ="" ;
    getSelectedCode();

    var table = $("#userList").DataTable({
        "aLengthMenu": [1, 2, 3, 4],
        "searching": false,//禁用搜索
        "lengthChange": false,
        "paging": true,//开启表格分页
        "bProcessing": true,
        "bServerSide": true,
        "bAutoWidth": false,
        "sort": "position",
        "deferRender": true,//延迟渲染
        "bStateSave": false, //在第三页刷新页面，会自动到第一页
        "iDisplayLength": 10,//每页显示条数
        "iDisplayStart": 0, //当前页
        "dom": '<l<\'#search\'>f>rt<ip><"clear">',
        "ordering": false,//全局禁用排序
        "ajax": {
            "url":server+ '/manage/user/list',
            "type": 'GET',
            "dataSrc": "detailModelList",
            "data": function (d) {
                d.name = $("#userName").val();
                d.userCode = userCode;
                d.saasId = saasId;
            }
        },
        "aoColumns": [{
            "mData": "code",
            "orderable": false, // 禁用排序
            "sDefaultContent": "",
            "sWidth": "2%"
        }, {
            "mData": "name",
            "orderable": false, // 禁用排序
            "sDefaultContent": "",
            "sWidth": "10%"
        },{
            "mData": "roleName",
            "orderable": false, // 禁用排序
            "sDefaultContent": "",
            "sWidth": "10%"
        }
        ],
        "columnDefs": [{
            "orderable": false, // 禁用排序
            "targets": [0], // 指定的列
            "data": "code",
            "render": function (data, type, full, meta) {
                var ind = $.inArray(data, selectedCode);
                if(ind>-1){
                    return '<input type="checkbox" value="' + data + '" name="code" checked="checked"  onclick="changeUserRole(this)" />';
                }
                return '<input type="checkbox" value="' + data + '" name="code" onclick="changeUserRole(this)" />';
            }
        }],
        "oLanguage": { // 国际化配置
            "sProcessing": "正在获取数据，请稍后...",
            "sLengthMenu": false,
            "sZeroRecords": "没有找到数据",
            "sInfo": "从 _START_ 到  _END_ 条记录 总记录数为 _TOTAL_ 条",
            "sInfoEmpty": "记录数为0",
            "sInfoFiltered": "(全部记录数 _MAX_ 条)",
            "sInfoPostFix": "",
            "sSearch": "搜索",
            "sUrl": "",
            "oPaginate": {
                "sFirst": "第一页",
                "sPrevious": "上一页",
                "sNext": "下一页",
                "sLast": "最后一页"
            }
        },
        initComplete: initComplete,
    })

    /**
     * 表格加载渲染完毕后执行的方法
     * @param data
     */
    function initComplete(data){
        var html = "<div style='margin-top: 10px;margin-bottom: -16px;'><label style='margin-right: 8px;'>用户名:</label><input name='name' id='userName''  style='width: 200px;height:33px;'/> <button type='button' class='btn btn-success search' >查 询</button> </div>";
        $("#search").append(html);

    }

   function changeUserRole(obj){
        var usercode = $(obj).val();
        var url=server+"/manage/userRole/changeUserRole";
        var data={
            userCode:userCode,
            roleCode:code,
            usercode:usercode
        };
        do_get(url,data,function(data){
            getSelectedCode();
            table.ajax.reload();
        },function(data){
            console.log(data);
        })
    }

    function getSelectedCode(){
        $.ajax({
            url:server+"/manage/userRole/getUserCodes",
            type: 'GET',
            data: {userCode:userCode,roleCode:code},
            success: function(data){
                selectedCode = data.obj;
            },
            dataType: "json",
            async:false
        })
    }

</script>