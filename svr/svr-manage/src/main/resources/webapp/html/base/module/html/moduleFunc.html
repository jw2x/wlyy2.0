<style>
    .userRole tr:nth-child(0) {
        background: #fff
    }
</style>
<link href="../../../common/css/bootstrap/plugins/jsTree/style.min.css" rel="stylesheet">
<script type="text/javascript" src="../../../common/js/plugins/jsTree/jstree.js"></script>
<div class="modal-header">
    <button type="button" class="close"
            data-dismiss="modal" aria-hidden="true">
        &times;
    </button>
    <h4 class="modal-title" id="myModalLabel">
        功能配置
    </h4>
</div>
<div id="divTree" style="width: 100%;height:500px;background: blanchedalmond; overflow:auto" ></div>
<div class="modal-footer">
    <form id="moduleFunForm" >
        <button type="button" class="btn btn-default"
                data-dismiss="modal" id="close">关闭
        </button>
        <button type="submit" class="btn btn-primary" id="btnsubmit">
            保存
        </button>
    </form>
</div>
<script>
    var moduleCode = $("#myModal").attr("data-code");
    var existFunCodes = "";
    getExistFunCodes();
    $("#divTree").jstree({
        "core": {
            'data' : function (node, callback) {
                var url = server+"/bases/function/listNoPage";
                var data = {
                    parentCode:"0"
                }
                var jsonarray = [];
                do_get(url,data ,function (result) {
                    changeData(result);
                    jsonarray = result;

                },function(data){

                },false)
                callback.call(this, jsonarray);
            }
        },
        "plugins": ["wholerow", "checkbox"],
        "checkbox": {
            "keep_selected_style": false
        }
    })

    $("#moduleFunForm").submit(function(){
        var codeArr = $('#divTree').jstree().get_checked(); //获取所有选中的节点
        var funCodes = codeArr.join(",");
        var data = {
            funCodes:funCodes,
           moduleCode:moduleCode
        };
        do_put(server+"/bases/moduleFun/changeFun",data,function(data){
            alert("保存成功");
            $("#close").click();
        },function(data){
        })
        return false;
    })


    /**
     * 获取当前模块存在的功能
     */
    function getExistFunCodes(){
        var url = server+"/bases/moduleFun/existFunc/"+moduleCode;
        do_get(url,{},function(data){
            existFunCodes = data;
        },function(data){

        },false)
    }

    /**
     * 将返回的数据封装成jstree可用的格式
     */
    function changeData(data){
        for(var i=0;i<data.length;i++){
            data[i].id = data[i].code;
            data[i].state={};
            data[i].state.selected=$.inArray(data[i].code,existFunCodes)>-1;
        }
        for(var i=0;i<data.length;i++){
            if(data[i].children.length>0){
                changeData(data[i].children)
            }
        }
    }

</script>